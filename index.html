<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed Image & PDF Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --dark: #3a0ca3;
            --light: #f8f9fa;
            --gray: #6c757d;
            --danger: #e63946;
            --warning: #fca311;
            --info: #48cae4;
            --border: #dee2e6;
            --shadow: rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
            margin-bottom: 30px;
        }
        
        header h1 {
            font-size: 2.8rem;
            color: var(--dark);
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        header p {
            font-size: 1.2rem;
            color: var(--gray);
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .designer-credit {
            font-size: 1rem;
            margin-top: 10px;
            color: var(--dark);
            font-weight: 600;
        }
        
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 10px;
        }
        
        .tab-btn {
            padding: 15px 30px;
            background: white;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px var(--shadow);
        }
        
        .tab-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        .tab-btn.active {
            background: var(--primary);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 6px 8px rgba(67, 97, 238, 0.3);
        }
        
        .converter-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            display: none;
        }
        
        .converter-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-title {
            font-size: 1.8rem;
            margin-bottom: 25px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            background: var(--primary);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .converter-card {
            display: flex;
            gap: 30px;
        }
        
        .upload-area {
            flex: 1;
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
        }
        
        .upload-area.drag-over {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
        }
        
        .upload-icon {
            font-size: 4rem;
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        .upload-text {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--gray);
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
        }
        
        .upload-btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
        }
        
        .controls {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .control-group label {
            font-weight: 600;
            color: var(--dark);
            font-size: 1.1rem;
        }
        
        .control-group input {
            padding: 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .control-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        
        .preview-area {
            flex: 1;
            border-radius: 12px;
            overflow: hidden;
            background: #f8f9fa;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .preview-title {
            padding: 15px;
            background: var(--dark);
            color: white;
            text-align: center;
            font-weight: 600;
        }
        
        .preview-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .preview-img {
            max-width: 100%;
            max-height: 250px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .action-btns {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
        }
        
        .btn-primary:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(67, 97, 238, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .btn-secondary:hover {
            background: rgba(67, 97, 238, 0.05);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .page-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
        }
        
        .page-item {
            position: relative;
            width: 80px;
            height: 100px;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        
        .page-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .page-number {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            text-align: center;
            padding: 3px;
            font-size: 0.8rem;
        }
        
        .page-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .page-btn {
            padding: 8px 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        
        .status.success {
            background: rgba(76, 201, 240, 0.2);
            border: 1px solid var(--success);
            color: var(--dark);
            display: block;
        }
        
        .status.error {
            background: rgba(230, 57, 70, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            display: block;
        }
        
        .file-info {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .file-info div {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .file-info span:first-child {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--gray);
        }
        
        .file-info span:last-child {
            color: var(--dark);
            font-weight: 600;
        }
        
        .add-page-btn {
            background: var(--info);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
        }
        
        .add-page-btn:hover {
            background: #3da0b8;
        }
        
        .remove-page-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
        }
        
        .progress-bar {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        footer {
            text-align: center;
            padding: 30px 0;
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        @media (max-width: 900px) {
            .converter-card {
                flex-direction: column;
            }
            
            .preview-area {
                min-height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Fixed Image & PDF Converter</h1>
            <p>Accurately convert images to specific file sizes and create PDFs with target sizes - all in your browser!</p>
            <p class="designer-credit">Designed by Suresh Suthar</p>
        </header>
        
        <div class="tabs">
            <button class="tab-btn active" data-tab="image-converter">Image to JPEG</button>
            <button class="tab-btn" data-tab="pdf-converter">Images to PDF</button>
        </div>
        
        <!-- Image to JPEG Converter -->
        <section id="image-converter" class="converter-section active">
            <h2 class="section-title">
                <i>📷</i>
                <span>Image to JPEG Converter</span>
            </h2>
            
            <div class="converter-card">
                <div class="upload-area" id="img-upload-area">
                    <div class="upload-icon">📁</div>
                    <p class="upload-text">Drag & drop your image here</p>
                    <p class="upload-text">- or -</p>
                    <button class="upload-btn">Choose Image</button>
                    <input type="file" id="img-file-input" class="file-input" accept="image/*">
                </div>
                
                <div class="controls">
                    <div class="control-group">
                        <label for="img-target-kb">Target File Size (KB)</label>
                        <input type="number" id="img-target-kb" min="10" value="200" placeholder="Enter target size in KB">
                    </div>
                    
                    <div class="preview-area">
                        <div class="preview-title">Image Preview</div>
                        <div class="preview-content">
                            <img id="img-preview" class="preview-img" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%23f0f2f5'/%3E%3Cpath d='M100,100 L300,100 L300,200 L100,200 Z' fill='%23dbe4f0'/%3E%3Ccircle cx='200' cy='150' r='50' fill='%23c3cfe2'/%3E%3C/svg%3E" alt="Preview">
                        </div>
                    </div>
                    
                    <div class="file-info">
                        <div>
                            <span>Original Size</span>
                            <span id="img-original-size">0 KB</span>
                        </div>
                        <div>
                            <span>Target Size</span>
                            <span id="img-target-size">200 KB</span>
                        </div>
                        <div>
                            <span>Current Quality</span>
                            <span id="img-quality">-</span>
                        </div>
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress" id="img-progress"></div>
                    </div>
                    
                    <div class="action-btns">
                        <button id="img-convert-btn" class="btn btn-primary" disabled>
                            <span>Convert to JPEG</span>
                        </button>
                        <button id="img-download-btn" class="btn btn-secondary" disabled>
                            <span>Download</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="img-status" class="status"></div>
        </section>
        
        <!-- PDF Converter -->
        <section id="pdf-converter" class="converter-section">
            <h2 class="section-title">
                <i>📄</i>
                <span>Images to PDF Converter</span>
            </h2>
            
            <div class="converter-card">
                <div class="upload-area" id="pdf-upload-area">
                    <div class="upload-icon">📑</div>
                    <p class="upload-text">Drag & drop your images here</p>
                    <p class="upload-text">- or -</p>
                    <button class="upload-btn">Choose Images</button>
                    <input type="file" id="pdf-file-input" class="file-input" accept="image/*" multiple>
                </div>
                
                <div class="controls">
                    <div class="control-group">
                        <label for="pdf-target-kb">Target PDF Size (KB)</label>
                        <input type="number" id="pdf-target-kb" min="100" value="500" placeholder="Enter target size in KB">
                    </div>
                    
                    <div class="preview-area">
                        <div class="preview-title">PDF Preview</div>
                        <div class="preview-content">
                            <img id="pdf-preview" class="preview-img" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%23f0f2f5'/%3E%3Crect x='50' y='50' width='300' height='200' fill='white' stroke='%23c3cfe2' stroke-width='2'/%3E%3Ctext x='200' y='120' text-anchor='middle' font-family='Arial' font-size='24' fill='%234361ee'%3EPDF Preview%3C/text%3E%3Ctext x='200' y='160' text-anchor='middle' font-family='Arial' font-size='16' fill='%236c757d'%3EAdd images to see preview%3C/text%3E%3C/svg%3E" alt="PDF Preview">
                        </div>
                    </div>
                    
                    <div class="file-info">
                        <div>
                            <span>Total Images</span>
                            <span id="pdf-image-count">0</span>
                        </div>
                        <div>
                            <span>Target Size</span>
                            <span id="pdf-target-size">500 KB</span>
                        </div>
                        <div>
                            <span>PDF Pages</span>
                            <span id="pdf-page-count">0</span>
                        </div>
                    </div>
                    
                    <button class="add-page-btn" id="add-page-btn">
                        <span>+ Add Another Page</span>
                    </button>
                    
                    <div class="page-list" id="page-list"></div>
                    
                    <div class="progress-bar">
                        <div class="progress" id="pdf-progress"></div>
                    </div>
                    
                    <div class="action-btns">
                        <button id="pdf-convert-btn" class="btn btn-primary" disabled>
                            <span>Create PDF</span>
                        </button>
                        <button id="pdf-download-btn" class="btn btn-secondary" disabled>
                            <span>Download PDF</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="pdf-status" class="status"></div>
        </section>
        
        <footer>
            <p>Fixed Image & PDF Converter Tool | All processing happens in your browser</p>
        </footer>
    </div>
    
    <script>
        // Tab switching
        const tabBtns = document.querySelectorAll('.tab-btn');
        const converterSections = document.querySelectorAll('.converter-section');
        
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // Update active tab button
                tabBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Show active section
                const tabId = btn.getAttribute('data-tab');
                converterSections.forEach(section => {
                    section.classList.remove('active');
                    if (section.id === tabId) {
                        section.classList.add('active');
                    }
                });
            });
        });
        
        // Initialize variables
        let currentImage = null;
        let convertedImageBlob = null;
        let pdfPages = [];
        let pdfBlob = null;
        
        // DOM elements for image converter
        const imgUploadArea = document.getElementById('img-upload-area');
        const imgFileInput = document.getElementById('img-file-input');
        const imgTargetKbInput = document.getElementById('img-target-kb');
        const imgPreview = document.getElementById('img-preview');
        const imgConvertBtn = document.getElementById('img-convert-btn');
        const imgDownloadBtn = document.getElementById('img-download-btn');
        const imgStatus = document.getElementById('img-status');
        const imgOriginalSize = document.getElementById('img-original-size');
        const imgTargetSize = document.getElementById('img-target-size');
        const imgQuality = document.getElementById('img-quality');
        const imgProgress = document.getElementById('img-progress');
        
        // DOM elements for PDF converter
        const pdfUploadArea = document.getElementById('pdf-upload-area');
        const pdfFileInput = document.getElementById('pdf-file-input');
        const pdfTargetKbInput = document.getElementById('pdf-target-kb');
        const pdfPreview = document.getElementById('pdf-preview');
        const pdfConvertBtn = document.getElementById('pdf-convert-btn');
        const pdfDownloadBtn = document.getElementById('pdf-download-btn');
        const pdfStatus = document.getElementById('pdf-status');
        const pdfImageCount = document.getElementById('pdf-image-count');
        const pdfTargetSize = document.getElementById('pdf-target-size');
        const pdfPageCount = document.getElementById('pdf-page-count');
        const pageList = document.getElementById('page-list');
        const addPageBtn = document.getElementById('add-page-btn');
        const pdfProgress = document.getElementById('pdf-progress');
        
        // Initialize file size displays
        imgTargetSize.textContent = imgTargetKbInput.value + ' KB';
        pdfTargetSize.textContent = pdfTargetKbInput.value + ' KB';
        
        // Update target sizes when inputs change
        imgTargetKbInput.addEventListener('input', () => {
            imgTargetSize.textContent = imgTargetKbInput.value + ' KB';
        });
        
        pdfTargetKbInput.addEventListener('input', () => {
            pdfTargetSize.textContent = pdfTargetKbInput.value + ' KB';
        });
        
        // Image upload handling
        imgUploadArea.addEventListener('click', () => {
            imgFileInput.click();
        });
        
        imgFileInput.addEventListener('change', handleImageFileSelect);
        
        // PDF upload handling
        pdfUploadArea.addEventListener('click', () => {
            pdfFileInput.click();
        });
        
        pdfFileInput.addEventListener('change', handlePdfFileSelect);
        
        // Add page button
        addPageBtn.addEventListener('click', () => {
            pdfFileInput.click();
        });
        
        // Drag and drop functionality
        function setupDragDrop(uploadArea, fileInput) {
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    
                    if (uploadArea.id === 'img-upload-area') {
                        handleImageFileSelect();
                    } else {
                        handlePdfFileSelect();
                    }
                }
            });
        }
        
        setupDragDrop(imgUploadArea, imgFileInput);
        setupDragDrop(pdfUploadArea, pdfFileInput);
        
        // Handle image file selection
        function handleImageFileSelect() {
            const file = imgFileInput.files[0];
            if (!file || !file.type.match('image.*')) {
                showStatus(imgStatus, 'Please select a valid image file.', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentImage = new Image();
                currentImage.onload = function() {
                    imgPreview.src = e.target.result;
                    imgOriginalSize.textContent = (file.size / 1024).toFixed(2) + ' KB';
                    imgConvertBtn.disabled = false;
                    imgDownloadBtn.disabled = true;
                    showStatus(imgStatus, 'Image loaded successfully. Click "Convert to JPEG" to process.', 'success');
                };
                currentImage.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // Handle PDF file selection - FIXED COUNT DISPLAY
        function handlePdfFileSelect() {
            const files = Array.from(pdfFileInput.files);
            if (files.length === 0) return;
            
            // Filter only image files
            const imageFiles = files.filter(file => file.type.match('image.*'));
            
            if (imageFiles.length === 0) {
                showStatus(pdfStatus, 'Please select valid image files.', 'error');
                return;
            }
            
            // Track added files
            let addedCount = 0;
            const totalFiles = imageFiles.length;
            
            imageFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // Create page object
                        const page = {
                            id: Date.now() + Math.random(),
                            file: file,
                            dataUrl: e.target.result,
                            img: img
                        };
                        
                        pdfPages.push(page);
                        addedCount++;
                        
                        // Only update UI after all files are processed
                        if (addedCount === totalFiles) {
                            updatePdfPreview();
                            updatePageList();
                            
                            // Update counts
                            pdfImageCount.textContent = pdfPages.length;
                            pdfPageCount.textContent = pdfPages.length;
                            pdfConvertBtn.disabled = pdfPages.length === 0;
                            
                            showStatus(pdfStatus, `Added ${imageFiles.length} image(s) to PDF. Total pages: ${pdfPages.length}`, 'success');
                        }
                    };
                    img.onerror = function() {
                        addedCount++;
                        if (addedCount === totalFiles) {
                            updatePageList();
                        }
                    };
                    img.src = e.target.result;
                };
                reader.onerror = function() {
                    addedCount++;
                    if (addedCount === totalFiles) {
                        updatePageList();
                    }
                };
                reader.readAsDataURL(file);
            });
        }
        
        // Update PDF preview
        function updatePdfPreview() {
            if (pdfPages.length === 0) {
                pdfPreview.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%23f0f2f5'/%3E%3Crect x='50' y='50' width='300' height='200' fill='white' stroke='%23c3cfe2' stroke-width='2'/%3E%3Ctext x='200' y='120' text-anchor='middle' font-family='Arial' font-size='24' fill='%234361ee'%3EPDF Preview%3C/text%3E%3Ctext x='200' y='160' text-anchor='middle' font-family='Arial' font-size='16' fill='%236c757d'%3EAdd images to see preview%3C/text%3E%3C/svg%3E";
                return;
            }
            
            // Show first page as preview
            pdfPreview.src = pdfPages[0].dataUrl;
        }
        
        // Update page list
        function updatePageList() {
            pageList.innerHTML = '';
            
            pdfPages.forEach((page, index) => {
                const pageItem = document.createElement('div');
                pageItem.className = 'page-item';
                pageItem.innerHTML = `
                    <img src="${page.dataUrl}" alt="Page ${index + 1}">
                    <div class="page-number">Page ${index + 1}</div>
                    <button class="remove-page-btn" data-id="${page.id}">×</button>
                `;
                
                pageItem.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('remove-page-btn')) {
                        pdfPreview.src = page.dataUrl;
                    }
                });
                
                pageList.appendChild(pageItem);
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-page-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = btn.getAttribute('data-id');
                    pdfPages = pdfPages.filter(page => page.id != id);
                    updatePdfPreview();
                    updatePageList();
                    
                    // Update counts after removal
                    pdfImageCount.textContent = pdfPages.length;
                    pdfPageCount.textContent = pdfPages.length;
                    pdfConvertBtn.disabled = pdfPages.length === 0;
                    
                    if (pdfPages.length === 0) {
                        showStatus(pdfStatus, 'All pages removed. Please add images.', 'error');
                    } else {
                        showStatus(pdfStatus, `Page removed. Total pages: ${pdfPages.length}`, 'success');
                    }
                });
            });
        }
        
        // Convert image to JPEG with target size
        imgConvertBtn.addEventListener('click', () => {
            if (!currentImage) {
                showStatus(imgStatus, 'Please select an image first.', 'error');
                return;
            }
            
            const targetKB = parseInt(imgTargetKbInput.value);
            if (isNaN(targetKB)) {
                showStatus(imgStatus, 'Please enter a valid target size.', 'error');
                return;
            }
            
            imgProgress.style.width = '0%';
            imgConvertBtn.disabled = true;
            imgConvertBtn.textContent = 'Processing...';
            
            try {
                const canvas = document.createElement('canvas');
                canvas.width = currentImage.width;
                canvas.height = currentImage.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(currentImage, 0, 0);
                
                // Quality adjustment to meet target size
                let quality = 90;
                let blob = null;
                let currentKB = 0;
                let iterations = 0;
                let maxIterations = 10;
                let progress = 0;
                
                // Function to process next iteration
                const processIteration = () => {
                    if (iterations >= maxIterations) {
                        finishConversion();
                        return;
                    }
                    
                    iterations++;
                    progress = (iterations / maxIterations) * 100;
                    imgProgress.style.width = progress + '%';
                    
                    blob = dataURLToBlob(canvas.toDataURL('image/jpeg', quality / 100));
                    currentKB = blob.size / 1024;
                    
                    if (Math.abs(currentKB - targetKB) < targetKB * 0.1) {
                        finishConversion();
                        return;
                    }
                    
                    // Adjust quality based on size difference
                    if (currentKB > targetKB) {
                        quality = Math.max(10, quality - 15);
                    } else {
                        quality = Math.min(95, quality + 10);
                    }
                    
                    setTimeout(processIteration, 50);
                };
                
                const finishConversion = () => {
                    convertedImageBlob = blob;
                    imgDownloadBtn.disabled = false;
                    imgQuality.textContent = quality + '%';
                    
                    showStatus(imgStatus, `Conversion complete! Final size: ${currentKB.toFixed(2)} KB (Target: ${targetKB} KB). Click Download to save.`, 'success');
                    imgConvertBtn.disabled = false;
                    imgConvertBtn.textContent = 'Convert to JPEG';
                };
                
                // Start processing
                processIteration();
            } catch (error) {
                showStatus(imgStatus, 'Error converting image: ' + error.message, 'error');
                imgConvertBtn.disabled = false;
                imgConvertBtn.textContent = 'Convert to JPEG';
            }
        });
        
        // Download converted image
        imgDownloadBtn.addEventListener('click', () => {
            if (!convertedImageBlob) {
                showStatus(imgStatus, 'No converted image available.', 'error');
                return;
            }
            
            const url = URL.createObjectURL(convertedImageBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'converted-image.jpg';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        
        // Create PDF
        pdfConvertBtn.addEventListener('click', async () => {
            if (pdfPages.length === 0) {
                showStatus(pdfStatus, 'Please add at least one image.', 'error');
                return;
            }
            
            const targetKB = parseInt(pdfTargetKbInput.value);
            if (isNaN(targetKB)) {
                showStatus(pdfStatus, 'Please enter a valid target size.', 'error');
                return;
            }
            
            pdfConvertBtn.disabled = true;
            pdfConvertBtn.textContent = 'Processing...';
            pdfProgress.style.width = '0%';
            
            try {
                showStatus(pdfStatus, 'Creating PDF...', 'success');
                
                // Create PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                
                // Add pages
                for (let i = 0; i < pdfPages.length; i++) {
                    if (i > 0) {
                        pdf.addPage();
                    }
                    
                    const page = pdfPages[i];
                    const width = pdf.internal.pageSize.getWidth();
                    const height = pdf.internal.pageSize.getHeight();
                    
                    // Calculate aspect ratio
                    const imgAspect = page.img.width / page.img.height;
                    const pdfAspect = width / height;
                    
                    let imgWidth, imgHeight;
                    if (imgAspect > pdfAspect) {
                        imgWidth = width - 20;
                        imgHeight = imgWidth / imgAspect;
                    } else {
                        imgHeight = height - 20;
                        imgWidth = imgHeight * imgAspect;
                    }
                    
                    // Center image on page
                    const x = (width - imgWidth) / 2;
                    const y = (height - imgHeight) / 2;
                    
                    // Compress the image for PDF
                    const canvas = document.createElement('canvas');
                    canvas.width = page.img.width;
                    canvas.height = page.img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(page.img, 0, 0);
                    
                    // Adjust quality based on target size
                    const targetPerPageKB = targetKB / pdfPages.length;
                    let quality = 80;
                    let compressedDataUrl = canvas.toDataURL('image/jpeg', quality / 100);
                    
                    // Check size and adjust if needed
                    let blob = dataURLToBlob(compressedDataUrl);
                    let currentKB = blob.size / 1024;
                    let iterations = 0;
                    
                    while (currentKB > targetPerPageKB * 1.2 && iterations < 5 && quality > 10) {
                        quality = Math.max(10, quality - 10);
                        compressedDataUrl = canvas.toDataURL('image/jpeg', quality / 100);
                        blob = dataURLToBlob(compressedDataUrl);
                        currentKB = blob.size / 1024;
                        iterations++;
                    }
                    
                    pdf.addImage(compressedDataUrl, 'JPEG', x, y, imgWidth, imgHeight);
                    
                    // Update progress
                    const progress = ((i + 1) / pdfPages.length) * 100;
                    pdfProgress.style.width = progress + '%';
                }
                
                // Generate PDF blob
                const pdfBlobData = pdf.output('blob');
                pdfBlob = pdfBlobData;
                
                pdfDownloadBtn.disabled = false;
                
                const actualKB = pdfBlobData.size / 1024;
                showStatus(pdfStatus, `PDF created successfully! Size: ${actualKB.toFixed(2)} KB (Target: ${targetKB} KB). Click Download to save.`, 'success');
                pdfConvertBtn.disabled = false;
                pdfConvertBtn.textContent = 'Create PDF';
            } catch (error) {
                showStatus(pdfStatus, 'Error creating PDF: ' + error.message, 'error');
                pdfConvertBtn.disabled = false;
                pdfConvertBtn.textContent = 'Create PDF';
            }
        });
        
        // Download PDF
        pdfDownloadBtn.addEventListener('click', () => {
            if (!pdfBlob) {
                showStatus(pdfStatus, 'No PDF available.', 'error');
                return;
            }
            
            const url = URL.createObjectURL(pdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'converted-document.pdf';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        
        // Helper function to show status
        function showStatus(element, message, type) {
            element.textContent = message;
            element.className = 'status ' + type;
        }
        
        // Helper function to convert data URL to blob
        function dataURLToBlob(dataURL) {
            const parts = dataURL.split(',');
            const mime = parts[0].match(/:(.*?);/)[1];
            const byteString = atob(parts[1]);
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            
            return new Blob([ab], { type: mime });
        }
    </script>
</body>
</html>